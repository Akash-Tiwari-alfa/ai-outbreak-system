{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
  <div class="col-12">
    <h2>Region Dashboard</h2>
    <p class="text-muted">
      Visual overview of outbreak risk levels across monitored regions.
    </p>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title mb-3">Outbreak Risk by Region</h5>
        <canvas id="regionRiskChart" height="140"></canvas>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">How to read this chart</h6>
        <p class="small text-muted">
          Each bar shows how many predictions are categorized as
          <span class="text-success fw-semibold">Low</span>,
          <span class="text-warning fw-semibold">Medium</span>, or
          <span class="text-danger fw-semibold">High</span>
          for a particular region.
        </p>
        <p class="small text-muted mb-0">
          Use this to quickly spot hotspots that require immediate attention.
        </p>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">Priority Regions</h6>
        {% if region_summary %}
          <ul class="list-group list-group-flush small">
            {% for r in region_summary[:5] %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ r.region }}</div>
                  <div class="text-muted">
                    {{ r.high_count }} high-risk / {{ r.total_predictions }} total
                  </div>
                </div>
                <span class="badge
                  {% if r.high_percent >= 60 %}bg-danger
                  {% elif r.high_percent >= 30 %}bg-warning text-dark
                  {% else %}bg-success{% endif %}
                ">
                  {{ r.high_percent }}%
                </span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="small text-muted mb-0">No regional data yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-12">
    <h5>Recent Predictions (Last 20)</h5>
  </div>
  <div class="col-12">
    {% if recent_predictions %}
      <div class="table-responsive shadow-sm bg-white rounded">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Time</th>
              <th>Region</th>
              <th>Fever</th>
              <th>Cough</th>
              <th>Diarrhea</th>
              <th>Population</th>
              <th>Risk</th>
              <th>Probability</th>
            </tr>
          </thead>
          <tbody>
          {% for p in recent_predictions %}
            <tr>
              <td>{{ p.timestamp }}</td>
              <td>{{ p.region }}</td>
              <td>{{ p.fever_cases }}</td>
              <td>{{ p.cough_cases }}</td>
              <td>{{ p.diarrhea_cases }}</td>
              <td>{{ p.region_population }}</td>
              <td>
                <span class="badge
                  {% if p.risk_level == 'High' %}bg-danger
                  {% elif p.risk_level == 'Medium' %}bg-warning text-dark
                  {% else %}bg-success{% endif %}
                ">
                  {{ p.risk_level }}
                </span>
              </td>
              <td>{{ p.probability }}%</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No predictions logged yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const labels = {{ labels | tojson }};
  const lowData = {{ low_counts | tojson }};
  const mediumData = {{ medium_counts | tojson }};
  const highData = {{ high_counts | tojson }};

  const ctx = document.getElementById('regionRiskChart').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Low Risk',
          data: lowData,
          backgroundColor: 'rgba(75, 192, 192, 0.7)'
        },
        {
          label: 'Medium Risk',
          data: mediumData,
          backgroundColor: 'rgba(255, 206, 86, 0.7)'
        },
        {
          label: 'High Risk',
          data: highData,
          backgroundColor: 'rgba(255, 99, 132, 0.7)'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
</script>
{% endblock %}
